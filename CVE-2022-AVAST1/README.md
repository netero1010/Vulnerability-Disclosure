# CVE-2022-AVAST1 (Arbitrary File Write that Leads to Defense Evasion and DOS)

## Product
Avast - Premium Security

## Version
21.11.2500 (build 21.11.6809.528)

## Vulnerable Component
AvastSvc.exe

## Description
When the malware threat detection is triggered, a directory "C:\\$AV_ASW\\$VAULT" and a file "vault.db" will be created by "AvastSvc.exe". Since the folder is assigned with "Modify" privilege for "Authenticated Users", any unprivileged users could modify/write this Avast controlled folder. With this setup, an unprivileged user is able to achieve arbitrary file write by creating a symbolic link from "vault.db" to a privileged location (e.g., C:\Windows\System32, C:\Program Files\Avast Software\Avast).

By abusing this vulnerability, an unprivileged user could implant empty DLLs (e.g., USERENV.dll, WTSAPI32.dll, and VERSION.dll) to antivirus protected location "C:\Program Files\Avast Software\Avast". These DLLs will then cause errors and terminate the Avast antivirus when they are loaded by the antivirus process (i.e., AvastSvc.exe) on next system reboot.

## Impact
The vulnerability could allow unprivileged user to terminate the Avast antivirus and cause DOS to the affected system.

## Steps to reproduce
1. Install Avast Premium Security (version 21.11.2500) and generate an alert for malware detection
2. Rename/delete the "C:\\$AV_ASW\\$VAULT" folder
3. Create a new "C:\\$AV_ASW\\$VAULT" and establish a symbolic link using the following command: (see [poc.png](https://github.com/netero1010/Vulnerability-Disclosure/blob/main/CVE-2022-AVAST1/poc.png))
```
CreateSymlink.exe c:\$AV_ASW\$VAULT\vault.db "C:\Program Files\Avast Software\Avast\poc.dll"
```
4. Trigger the malware detection again and the "C:\\Program Files\\Avast Software\\Avast\\poc.dll" will be subsequently dropped to the privileged location as "NT AUTHORITY/SYSTEM" (see [poc1.png](https://github.com/netero1010/Vulnerability-Disclosure/blob/main/CVE-2022-AVAST1/poc1.png))

## Resolution

This vulnerability is patched since Avast Premium Security 22.1.

## Disclosure Timeline

19-01-2022 Vulnerability reported to Avast.

22-01-2022 Initial response from Avast.

11-02-2022 Avast confirmed the vulnerability and released a patch for the product.

## References
https://forum.avast.com/index.php?topic=317641.0
